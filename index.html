<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>A-Frame Maze</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="goal.js"></script>
  <script src="target-spawner.js"></script>
  
  <script src="score-manager.js"></script>
  <script src="score-display.js"></script>
  <script src="shoot_countDown.js"></script>
  <script src="target-life.js"></script>

  <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v7.2.0/dist/aframe-extras.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-msdf-text-component/dist/aframe-msdf-text-component.min.js"></script>

  <style>
    body { margin: 0; overflow: hidden; }
  </style>

</head>
<body>

<a-scene>
  <a-assets>
    <a-asset-item id="cork" src="cork.glb"></a-asset-item><!--コルク-->
    <a-asset-item id="kabe2" src="wall.glb"></a-asset-item><!--壁-->
    <a-asset-item id="yuka" src="tile.glb"></a-asset-item><!--床-->
    <a-asset-item id="goal" src="start.glb"></a-asset-item><!--ゴール-->
    <a-asset-item id="timer" src="timer.glb"></a-asset-item>
    <a-asset-item id="mato" src="mato.glb"></a-asset-item>
    <a-asset-item id="map" src="ku-kan.glb"></a-asset-item>
  </a-assets>
  <a-sky color="black"></a-sky><!--空の色-->
  <!-- シンプルなプレイヤー設定 -->
  <a-entity id="rig"
    movement-controls="speed: 0.2"
    arrival-check="destination: 31 1.6 35; onarrival: 100 50 100"
    vr-trigger-shoot
    position="3 1.6 10">
    <!-- カメラの設定（感度など） -->
    <a-entity id="camera"
      camera
      cork-shooter
      position="0 0 0"
      score-display="hudSelector: #scoreHud">
      <!-- タイマー -->
      <a-plane position="0 -0.5 -1.21" width="1.2" height="0.4" color="#000" opacity="0.5" material="shader: flat"></a-plane>
      <a-entity id="timerText" text="value: 60; color: red; align: center" width: 3 scale="2 2 2" position="0 -0.5 -1.2"></a-entity>
      <!-- クロスヘア -->
      <a-entity id="crosshair"
                geometry="primitive: ring; radiusInner: 0.002; radiusOuter: 0.004"
                material="color: red; shader: flat"
                position="0 0 -1">
      </a-entity>
      <!--残弾数-->
      <a-entity id="ammoHud"
            text="value: ammo: 10; color: red; align: left; shader: msdf"
            position="-0.4 -0.6 -1"
            scale="1 1 1">
      </a-entity>
      <!-- スコア表示 -->
      <a-entity id="scoreHud"
          text="value: score: 0; color: yellow; align: right; shader: msdf"
          position="0.4 -0.6 -1"
          scale="1 1 1">
      </a-entity>
      <a-entity id="countdown" 
        shoot-countdown="time: 3">
      </a-entity>

      <a-entity id="rightHand"
        oculus-touch-controls="hand: right; model: true"
        laser-controls="hand: right">
      </a-entity>
      <a-entity id="leftHand"
        oculus-touch-controls="hand: left; model: true"
        laser-controls="hand: left">
      </a-entity>



    </a-entity>

  </a-entity>

  <a-entity gltf-model="#map"
    position = "100 40 100"
    scale = "3 3 3"
  ></a-entity>


  <a-entity id="maze"></a-entity>
  <a-entity gltf-model="#goal" position="31 0.6 35" scale="0.5 1.3 0.5" rotation="0 90 0"></a-entity>

  <!-- スコアマネージャー（シーン直下に配置） -->
  <a-entity id="scoreManager" score-manager></a-entity>

  <!-- スポナー（テレポート先の付近で自動起動） -->
  <a-entity id="targetSpawner"
    target-spawner="center: 100 50 100;
    totalTargets: 12;
    duration: 20;
    radiusMin: 15;
    radiusMax: 35;
    heightMin: 50;
    heightMax: 60;">
  </a-entity>

</a-scene>

<div style="position: fixed; bottom: 20px; left: 20px; color: white; background: rgba(0,0,0,0.7); padding: 10px; border-radius: 5px; font-family: sans-serif; font-size: 14px; z-index: 1000;">
  💡 画面をクリックして視点操作を開始<br>
  マウスで視点移動 / WASDキーで移動 / ESCキーで終了
</div>

<script> 
  //1行下の文はグローバルスコープで動く必要があるため25行くらい下の<script type="module">の前に書く 
  AFRAME.registerComponent("distance-check", { 
    //schema は、コンポーネントに対してプロパティ（設定項目）を定義するために使う 
    schema: { 
    range: { type: "number", default: 0.5 },  // 取得距離 
    isEnabled: { type: "boolean", default: true } // コンポーネントの有効/無効フラグ 
  }, 
    tick: function () { 
      //コンポーネントが無効化されている場合、処理を終了 
      if(!this.data.isEnabled) return; 

      const item = this.el; 
      const rig = document.querySelector("#rig"); 

      if (!rig) return; 

      //リグの中にカメラを付属（つまりリグにカメラがひっついており、カメラの座標自体は固定）しているので、リグの位置を取得する 
      const rigPos = rig.object3D.position;//リグの位置取得 
      const itemPos = item.object3D.position;//アイテムの位置取得 
      const distance = itemPos.distanceTo(rigPos);//アイテムとカメラの距離を計算 

      console.log("リグの位置: ",rigPos); // リグの位置をログ出力 
      console.log(`アイテムとの距離: ${distance}`); // 距離をログ出力 

      //「range」を使用してアイテムと自分（リグ）の距離が指定以下まで近づいたとき 
      if (distance < this.data.range) { 

        //windowをつけるとグローバル変数になり、ほかの関数で定義された変数を使用できる 
        window.shot_time += 3; 

        item.parentNode.removeChild(item);//アイテムの削除 
        //item.removeAttribute('distance-check'); // 既存のコンポーネントを削除 
        //distance-checkコンポーネントのenabled属性をfalseに設定する方法 
        this.el.setAttribute("distance-check", "isEnabled", false);//1アイテム１回のみ取得判定を行うためｎフラグを使用 
      } 
    } 
  }); 
  </script> 
 
<script>

  import './CorkFromTheEye.js';
 
AFRAME.registerComponent('vr-trigger-shoot', { //トリガー操作コンポーネント
  init: function () {
    this.prevPressed = false;
  },
 
  tick: function () {
    const rightHand = document.querySelector('[oculus-touch-controls][hand="right"]');
    if (!rightHand) return;
 
    const controls = rightHand.components['oculus-touch-controls'];
    if (!controls || !controls.controller) return;
 
    const gamepad = controls.controller.gamepad;
    if (!gamepad) return;
 
    const pressed = gamepad.buttons[0].pressed; // トリガー
 
    // 押した瞬間だけ
    if (pressed && !this.prevPressed) {
      this.fire();
    }
 
    this.prevPressed = pressed;
  },
 
  fire: function () {
    const camera = document.querySelector('#camera');
    if (!camera) return;
 
    const shooter = camera.components['cork-shooter'];
    if (shooter && shooter.shootCork) {
      shooter.shootCork(); // ← スペースキーと完全に同じ処理
    }
  }
});
 


import { createKabe } from "./createkabe.js";
import { createFloors } from "./floor.js";
import { putTimer } from "./putTimer.js";
import { startTimer } from './timer.js';

const mazeArray = [
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
  [1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,0,1],
  [1,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1],
  [1,0,1,0,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1],
  [1,0,1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1],
  [1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1],
  [1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0,1],
  [1,1,1,1,1,1,1,1,1,0,1,0,1,0,1,1,1,1,1],
  [1,0,0,0,0,0,0,0,1,0,1,0,1,0,1,0,0,0,1],
  [1,0,1,1,1,1,1,1,1,0,1,0,1,0,1,0,1,1,1],
  [1,0,1,0,0,0,0,0,0,0,1,0,1,0,1,0,0,0,1],
  [1,0,1,0,1,1,1,1,1,0,1,1,1,0,1,1,1,0,1],
  [1,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,1],
  [1,0,1,1,1,1,1,0,1,1,1,1,1,0,1,1,1,1,1],
  [1,0,1,0,0,0,1,0,1,0,0,0,0,0,0,0,1,0,1],
  [1,0,1,1,1,0,1,0,1,1,1,0,1,0,1,0,1,0,1],
  [1,0,0,0,0,0,1,0,0,0,0,0,1,0,1,0,0,0,1],
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
];

document.querySelector("a-scene").addEventListener("loaded", () => {
    const scene = document.querySelector("#maze");

    createKabe(scene, mazeArray);
    createFloors(scene, 19);

    startTimer();//カウントダウンスタート

    console.log("Maze generated after assets loaded");
});

const itemPositions = [
      [3,1],[5,11],[13,7],[15,15],[17,5]
    ];
    //pos[0]がx座標、pos[1]がy座標
    itemPositions.forEach(pos => putTimer(pos[0], pos[1], '#timer'));

</script>
</body>

</html>
